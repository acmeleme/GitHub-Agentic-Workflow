name: GitHub Agentic Workflow Demo

on:
  issues:
    types: [opened, labeled, edited]
  workflow_dispatch:
    inputs:
      feature_summary:
        description: Feature or bug request to run through Architect â†’ Developer â†’ QA
        required: true
        type: string
      priority:
        description: Priority for the run
        required: true
        default: medium
        type: choice
        options:
          - low
          - medium
          - high
      issue_number:
        description: Optional issue number to attach updates to
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  intake:
    name: Intake
    runs-on: ubuntu-latest
    outputs:
      run_demo: ${{ steps.intake.outputs.run_demo }}
      request_text: ${{ steps.intake.outputs.request_text }}
      source_ref: ${{ steps.intake.outputs.source_ref }}
      tracking_id: ${{ steps.intake.outputs.tracking_id }}
      issue_number: ${{ steps.intake.outputs.issue_number }}
      priority: ${{ steps.intake.outputs.priority }}
      skip_reason: ${{ steps.intake.outputs.skip_reason }}
    steps:
      - id: intake
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            const action = context.payload.action || "";
            const issue = context.payload.issue;
            const labels = issue?.labels?.map(l => l.name) || [];
            const issueNumberFromEvent = issue?.number ? String(issue.number) : "";
            const issueNumberFromInput = core.getInput("issue_number");
            const issueNumber = issueNumberFromInput || issueNumberFromEvent;

            const issueTitle = issue?.title || "";
            const issueBody = issue?.body || "";
            const hasAgenticLabel = labels.includes("agentic-demo");
            const hasDemoTitlePrefix = issueTitle.toLowerCase().startsWith("[agentic demo]");

            const runFromIssue = eventName === "issues" && (hasAgenticLabel || hasDemoTitlePrefix);
            const runFromManual = eventName === "workflow_dispatch";
            const runDemo = runFromIssue || runFromManual;
            const skipReason = runDemo
              ? ""
              : `Issue did not match demo trigger. action=${action}, has_label=${hasAgenticLabel}, title_prefix=${hasDemoTitlePrefix}`;

            const requestFromIssue = [issueTitle, issueBody].filter(Boolean).join("\n\n").trim();
            const requestFromManual = core.getInput("feature_summary");
            const requestText = (requestFromManual || requestFromIssue || "No request details provided").trim();
            const priority = core.getInput("priority") || "medium";

            const sourceRef = issueNumber ? `issue#${issueNumber}` : "manual";
            const trackingId = `AGD-${context.runId}-${Date.now()}`;

            core.setOutput("run_demo", String(runDemo));
            core.setOutput("request_text", requestText);
            core.setOutput("source_ref", sourceRef);
            core.setOutput("tracking_id", trackingId);
            core.setOutput("issue_number", issueNumber);
            core.setOutput("priority", priority);
            core.setOutput("skip_reason", skipReason);

            if (runDemo && issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(issueNumber),
                body: [
                  `ğŸš€ Agentic demo started`,
                  `- Tracking: ${trackingId}`,
                  `- Source: ${sourceRef}`,
                  `- Priority: ${priority}`,
                  `- Pipeline: Architect â†’ Developer â†’ QA`
                ].join("\n")
              });
            }

            if (!runDemo && issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(issueNumber),
                body: [
                  `â­ï¸ Agentic demo skipped`,
                  `- Reason: ${skipReason}`,
                  `- To trigger: add label \`agentic-demo\` or use title prefix \`[Agentic Demo]\`.`
                ].join("\n")
              });
            }

  architect:
    name: Architect
    needs: intake
    if: needs.intake.outputs.run_demo == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Build architecture handoff
        run: |
          mkdir -p out
          cat > out/architect-report.md << 'EOF'
          # Architect Report

          ## Tracking
          - ID: ${{ needs.intake.outputs.tracking_id }}
          - Source: ${{ needs.intake.outputs.source_ref }}
          - Priority: ${{ needs.intake.outputs.priority }}

          ## Normalized Request
          ${{ needs.intake.outputs.request_text }}

          ## Proposed Solution
          - Clarify scope and non-goals from request.
          - Identify impacted modules and interfaces.
          - Define acceptance criteria with observable outcomes.

          ## Task Breakdown
          1. Create or update implementation files.
          2. Add or update tests for acceptance criteria.
          3. Update docs and usage notes.

          ## Acceptance Criteria
          - Requirements are implemented and traceable.
          - Tests pass for changed behavior.
          - Documentation includes what changed and how to validate.
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: architect-report
          path: out/architect-report.md

      - name: Post architect status
        if: needs.intake.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(`${{ needs.intake.outputs.issue_number }}`),
              body: [
                `ğŸ—ï¸ Architect completed`,
                `- Tracking: ${{ needs.intake.outputs.tracking_id }}`,
                `- Artifact: architect-report`
              ].join("\n")
            });

  developer:
    name: Developer
    needs: [intake, architect]
    if: needs.intake.outputs.run_demo == 'true'
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr_meta.outputs.pr_number }}
      pr_url: ${{ steps.pr_meta.outputs.pr_url }}
      pr_status: ${{ steps.pr_meta.outputs.pr_status }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: architect-report
          path: in

      - name: Generate implementation
        run: |
          mkdir -p generated-app
          cat > generated-app/app.py << 'EOF'
          from flask import Flask, jsonify

          app = Flask(__name__)


          @app.get("/health")
          def health():
              return jsonify({"status": "ok"}), 200


          if __name__ == "__main__":
              app.run(host="0.0.0.0", port=8000)
          EOF

          cat > generated-app/requirements.txt << 'EOF'
          flask==3.1.0
          EOF

          cat > generated-app/README.md << EOF
          # Generated App

          This app was generated by the Developer stage of the agentic workflow.

          ## Request Source
          - ${{ needs.intake.outputs.source_ref }}

          ## Run locally
          \
          pip install -r generated-app/requirements.txt
          python generated-app/app.py
          \

          ## Health check
          - GET /health returns {"status": "ok"}
          EOF

          cat > generated-app/.generated-run.txt << EOF
          tracking_id=${{ needs.intake.outputs.tracking_id }}
          request=${{ needs.intake.outputs.request_text }}
          generated_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      - name: Create developer PR
        id: create_pr
        continue-on-error: true
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(agentic-demo): generated app for ${{ needs.intake.outputs.source_ref }}"
          branch: "demo/${{ needs.intake.outputs.tracking_id }}"
          title: "feat(agentic-demo): implement request from ${{ needs.intake.outputs.source_ref }}"
          body: |
            ## Agentic Developer Output
            - Tracking: ${{ needs.intake.outputs.tracking_id }}
            - Source: ${{ needs.intake.outputs.source_ref }}
            - Request:
              ${{ needs.intake.outputs.request_text }}

            ## Generated Files
            - generated-app/app.py
            - generated-app/requirements.txt
            - generated-app/README.md
            - generated-app/.generated-run.txt

      - name: Resolve PR metadata
        id: pr_meta
        run: |
          branch_name="demo/${{ needs.intake.outputs.tracking_id }}"
          pr_number="${{ steps.create_pr.outputs.pull-request-number }}"
          pr_url="${{ steps.create_pr.outputs.pull-request-url }}"

          if [ -n "$pr_url" ]; then
            pr_status="created"
          else
            pr_status="manual-required"
            pr_url="https://github.com/${{ github.repository }}/pull/new/$branch_name"
          fi

          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"
          echo "pr_status=$pr_status" >> "$GITHUB_OUTPUT"

      - name: Build developer handoff
        run: |
          mkdir -p out
          cat > out/developer-report.md << EOF
          # Developer Report

          ## Tracking
          - ID: ${{ needs.intake.outputs.tracking_id }}

          ## Inputs
          - Architect handoff: in/architect-report.md

          ## Implementation Summary
          - Generated a runnable Flask app with a health endpoint.
          - Added dependency file and app-specific README.

          ## Pull Request
          - Number: ${{ steps.pr_meta.outputs.pr_number }}
          - URL: ${{ steps.pr_meta.outputs.pr_url }}
          - Status: ${{ steps.pr_meta.outputs.pr_status }}
          - Branch: demo/${{ needs.intake.outputs.tracking_id }}
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: developer-report
          path: out/developer-report.md

      - name: Post developer status
        if: needs.intake.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(`${{ needs.intake.outputs.issue_number }}`),
              body: [
                `ğŸ’» Developer completed`,
                `- Tracking: ${{ needs.intake.outputs.tracking_id }}`,
                `- PR: ${{ steps.pr_meta.outputs.pr_url }}`,
                `- PR Status: ${{ steps.pr_meta.outputs.pr_status }}`,
                `- Artifact: developer-report`
              ].join("\n")
            });

  qa:
    name: QA
    needs: [intake, developer]
    if: needs.intake.outputs.run_demo == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: developer-report
          path: in

      - name: Build QA handoff
        run: |
          mkdir -p out
          cat > out/qa-report.md << 'EOF'
          # QA Report

          ## Tracking
          - ID: ${{ needs.intake.outputs.tracking_id }}

          ## Verification Scope
          - Validate acceptance criteria coverage.
          - Validate test strategy and quality gates.
          - Capture go/no-go recommendation.

          ## Pull Request Under Review
          - Number: ${{ needs.developer.outputs.pr_number }}
          - URL: ${{ needs.developer.outputs.pr_url }}

          ## Result
          - Status: âœ… Demo Pass
          - Findings: No blocking defects in mocked flow.
          - Recommendation: Approve for demo merge gate.
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: qa-report
          path: out/qa-report.md

      - name: Post QA status
        if: needs.intake.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(`${{ needs.intake.outputs.issue_number }}`),
              body: [
                `ğŸ§ª QA completed`,
                `- Tracking: ${{ needs.intake.outputs.tracking_id }}`,
                `- Result: Demo Pass`,
                `- Artifact: qa-report`
              ].join("\n")
            });

  summary:
    name: Summary
    needs: [intake, architect, developer, qa]
    if: always() && needs.intake.outputs.run_demo == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Build summary
        run: |
          mkdir -p out
          cat > out/execution-summary.md << 'EOF'
          # Agentic Workflow Execution Summary

          - Tracking: ${{ needs.intake.outputs.tracking_id }}
          - Source: ${{ needs.intake.outputs.source_ref }}
          - PR: ${{ needs.developer.outputs.pr_url }}
          - Architect: ${{ needs.architect.result }}
          - Developer: ${{ needs.developer.result }}
          - QA: ${{ needs.qa.result }}

          ## Outcome
          - End-to-end role flow executed.
          - Artifacts generated for all role handoffs.
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: execution-summary
          path: out/execution-summary.md

      - name: Post final summary to issue
        if: needs.intake.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(`${{ needs.intake.outputs.issue_number }}`),
              body: [
                `âœ… Agentic demo finished`,
                `- Tracking: ${{ needs.intake.outputs.tracking_id }}`,
                `- PR: ${{ needs.developer.outputs.pr_url }}`,
                `- Architect: ${{ needs.architect.result }}`,
                `- Developer: ${{ needs.developer.result }}`,
                `- QA: ${{ needs.qa.result }}`,
                `- Artifact: execution-summary`
              ].join("\n")
            });
